class HofHtmlElement extends HTMLElement{_tagName;_root;_shadow;_observables={};_properties={};_allProperties=null;_elementAttributeBindParams=new Map;_bindingExpressions=[];_renderIteration=-1;_listTemplate="";_listData=[];_listIt="";_listStart=0;static _actions={};PROPS_FILTER=t=>"_"!=t.charAt(0)&&t!=t.toUpperCase()&&"constructor"!=t&&"render"!=t;constructor(t="div"){super(),this._tagName=t,this._shadow=this.attachShadow({mode:"closed"})}dispatch(t,e){HofHtmlElement._actions[t]?.forEach((t=>t(e)))}callback(t,e){HofHtmlElement._actions[t]||(HofHtmlElement._actions[t]=[]),HofHtmlElement._actions[t].push(e.bind(this))}connectedCallback(){this._root=document.createElement(this._tagName),this._root.partialRenderingSupport=!0,this._shadow.appendChild(this._root),this._hasParentElementWithPartialRenderingSupport()||this.render()}useAutoProps(){this._forEachPropertyOfObjectAndPrototype(((t,e)=>{const s=e[t];if(t.startsWith("event-")&&delete e[t=t.substring(6)],"callbacks"==t&&"function"==typeof s){const t=s.call(this);for(var r of Object.keys(t))this.callback(r,t[r])}else"construct"==t&&"function"==typeof s?s.call(this):Object.defineProperty(this,t,{get:function(){return this.getProperty(t,s)},set:function(e){this.setProperty(t,e)},enumerable:!0,configurable:!0})}))}setProperty(t,e){const s=this._properties[t];("object"==typeof s||"object"==typeof e||s!=e||e.lastActionMethod)&&(this._properties[t]=e,this._allProperties&&(this._allProperties[t]=e),this._updatePropertyObservers([t,e,s])),this._allProperties&&this._makePropertyObservable(t)}getProperty(t,e){return this._allProperties?this._allProperties[t]:this._properties[t]??this.getAttribute(t)??e}renderContent(t,e){this._renderFull(t,e)}renderList(t,e,s){const r=e.toString(),i=r.substring(r.indexOf("(")+1,r.indexOf(")"));this._listData=t,this._listIt=i,this._listTemplate=e,this._listStart=this._root.childNodes.length,void 0!==s&&null!=s||(s={});for(const t of this._listData)s[this._listIt]=t,this.renderContent(e,s)}_hasParentElementWithPartialRenderingSupport(){let t=this.parentNode;for(;null!=t;){if(t.partialRenderingSupport)return!0;t=t.parentNode}return!1}_calculateProperties(){let t={};this._forEachPropertyOfObjectAndPrototype(((e,s)=>t[e]=s[e])),this._allProperties=t}_forEachPropertyOfObjectAndPrototype(t){for(const e of Object.getOwnPropertyNames(this).filter(this.PROPS_FILTER))t(e,this);const e=Object.getPrototypeOf(this);for(const s of Object.getOwnPropertyNames(e).filter(this.PROPS_FILTER))t(s,e)}_convertToTemplateExpression(t){let e=t.toString();const s=e.indexOf("`");return s>0&&(e=e.substring(s+1,e.length-1)),e}_parseHTML(t,e){"function"==typeof t&&(t=this._convertToTemplateExpression(t)),null==this._allProperties&&this._calculateProperties();const s=this._allProperties,[r,i]=this._calculateTemplateAndBindParams(t,s,e);this._calculateBindings(r,i);return[(new DOMParser).parseFromString(r,"text/html").body.childNodes,s,i]}_makePropertyObservable(t){for(const e of this._bindingExpressions[t])this._makePropertyStructureObservable(t,e)}_makePropertyStructureObservable(t,e){const s=this._allProperties[t],r=e.split(".");let i=s,o=t;for(let e=0;e<r.length;e++){let s=r[e];if(o+=`.${r[e]}`,void 0===i)return;i[s];"object"==typeof i&&(Array.isArray(i)?this._makeArrayObservable(i,t):this._makeObjectObservable(i,s,t,o)),i=i[r[e]]}}_makeObjectObservable(t,e,s,r){let i=t[e];Object.defineProperty(t,e,{get:function(){return i}.bind(this),set:function(t){i=t;let e=this.getProperty(s);e.lastActionMethod="SET",e.lastActionPropertyPath=r,this.setProperty(s,e),e.lastActionMethod=null,e.lastActionPropertyPath=null}.bind(this),enumerable:!0,configurable:!0})}_makeArrayObservable(t,e){t._observers||(t._observers=new Map),t._observers.has(this)||t._observers.set(this,[]),t._observers.get(this).includes(e)||(t._observers.get(this).push(e),t._emit=function(t,e){return 0==e.length?this.lastActionMethod="DELETE":null==t?this.lastActionMethod="ADD":1==e.length&&(this.lastActionMethod="EDIT"),this.lastActionIndex=t??this.length-1,this._observers.forEach(((t,e)=>t.forEach((t=>e.setProperty(t,this))))),this.lastActionMethod=null,this.lastActionIndex=null,this},t.push=function(e){return Array.prototype.push.call(this,e),t._emit(null,[e])},t.splice=function(e,s,...r){if(Array.prototype.splice.call(this,e,s,...r),s<=1)return t._emit(e,r)},t.edit=function(t,e){return this.splice(t,1,e)},t.delete=function(t){return this.splice(t,1)})}_calculateBindings(t,e){for(let s of e){const e=new RegExp(`(${s})((\\.[\\w]+)*)`,"g");this._bindingExpressions[s]=[];for(const[,,r]of t.matchAll(e)){const t=r.substring(1);this._bindingExpressions[s].includes(t)||this._bindingExpressions[s].push(t)}this._makePropertyObservable(s)}}_renderFull(t,e){const[s,r,i]=this._parseHTML(t,e),o=this._root.childNodes.length;for(;s.length>0;)this._root.appendChild(s[0]);for(let t=o;t<this._root.childNodes.length;t++)this._processElementBinding(this._root.childNodes[t],r,i)}_renderUpdate(t){if(""!=this._listTemplate){const[e,s,r]=this._parseHTML(this._listTemplate,{[this._listIt]:this._listData[t.lastActionIndex]});"ADD"==t.lastActionMethod?(this._root.childNodes[t.lastActionIndex]?this._root.insertBefore(e[0],this._root.childNodes[this._listStart+t.lastActionIndex-1].nextSibling):this._root.appendChild(e[0]),this._processElementBinding(this._root.childNodes[this._listStart+t.lastActionIndex],s,r)):"EDIT"==t.lastActionMethod?(this._root.replaceChild(e[0],this._root.childNodes[this._listStart+t.lastActionIndex]),this._processElementBinding(this._root.childNodes[this._listStart+t.lastActionIndex],s,r)):"DELETE"==t.lastActionMethod&&this._root.childNodes[this._listStart+t.lastActionIndex].remove()}}_calculateTemplateAndBindParams(t,e,s){this._renderIteration++;const r=Object.keys(e);if(s)for(let[i,o]of Object.entries(s)){const s=i+this._renderIteration;e[s]=o,r.push(s);const n=new RegExp(`(${i})([^=-])`,"g");for(const[e,r,i]of t.matchAll(n))t=t.replace(e,`${s}${i}`);o&&(t=t.replaceAll(`live(${s})`,o.toString().substring(6)))}return[t,r]}_processElementBinding(t,e,s){if(t.templateExpressions||(t.templateExpressions={}),t.attributes&&Array.from(t.attributes).forEach((r=>{r.nodeValue.includes("${")&&this._processBindingExpression(t,e,s,r.nodeName,r.nodeValue)})),t.data&&t.data.includes("${")&&this._processBindingExpression(t,e,s,"data",t.data),t.childNodes)for(const r of t.childNodes)this._processElementBinding(r,e,s);t.render&&t.render()}_processBindingExpression(t,e,s,r,i){const[o,n]=this._buildCallableExpression(r,i,s);this._registerObservable(t,r,e,o,n,i);let l=[];for(const t of o)l.push(e[t]);t[r]=n(...l)}_buildCallableExpression(t,e,s){e="data"==t?"`"+e+"`":e.replaceAll("${","").replaceAll("}","");let r=[];for(const t of s)e.includes(t)&&r.push(t);return[r,new Function(...r,"return "+e).bind(this)]}_registerObservable(t,e,s,r,i,o){this._elementAttributeBindParams.has(t)||this._elementAttributeBindParams.set(t,{}),this._elementAttributeBindParams.get(t)[e]=r;for(let o of r){this._observables[o]||(this._observables[o]=new Map);const r=this._observables[o];r.has(t)||r.set(t,{}),s[o].bind&&(s[o]=s[o].bind(this)),r.get(t)[e]=i}t.templateExpressions[e]=o}_updatePropertyObservers(t){const[e,s,r]=t,i=this._allProperties;if(this._observables[e])for(const[t,r]of this._observables[e].entries())for(const[e,o]of Object.entries(r)){let r=[];for(const s of this._elementAttributeBindParams.get(t)[e])r.push(i[s]);const n=o(...r);(!s.lastActionPropertyPath||t.templateExpressions[e]&&t.templateExpressions[e].includes(s.lastActionPropertyPath))&&(n.lastActionMethod?t._renderUpdate(n):t[e]=n)}}}function component(t,e,s="div"){let r=class extends HofHtmlElement{constructor(){super(s),super.useAutoProps()}};for(const t of Object.keys(e))if("render"==t){const s=e[t](),n=o(t);if(Array.isArray(s)){const t=[];if(s.length>0&&Array.isArray(s[0]))for(const e of s)t.push(i(e));else t.push(i(s));r.prototype.render=function(){t.forEach((t=>t(this,n)))}}else r.prototype.render=function(){this.renderContent(s,n)}}else r.prototype["event-"+t]=e[t];function i(t){return 1==t.length?function(e,s){e.renderContent(t[0],s)}:2==t.length&&"function"==typeof t[0]?function(e){e.renderContent(t[0],t[1])}:t.length>=2&&"function"==typeof t[1]?function(e,s){e.renderList(e[t[0]]??t[0],t[1],t[2]??s)}:void 0}function o(t){let s=e[t].toString(),r=s.indexOf("{")+1,i=s.indexOf("return"),o=s.substring(r,i);const n=new RegExp("let[\\W]+([\\w]+)[\\W]*=","g"),l=[];for(const[,t]of o.matchAll(n))l.push(t);return o+="return {"+l.join(",")+"}",new Function(o).call(e)}customElements.define(t,r)}
